C251 COMPILER V5.60.0,  control                                                            11/10/23  17:40:20  PAGE 1   


C251 COMPILER V5.60.0, COMPILATION OF MODULE control
OBJECT MODULE PLACED IN .\Out_File\control.obj
COMPILER INVOKED BY: D:\Software\Keil_v5\C251\BIN\C251.EXE ..\USER\src\control.c XSMALL UNSIGNED_CHAR WARNINGLEVEL(3) BR
                    -OWSE INCDIR(..\..\Libraries\libraries;..\..\Libraries\seekfree_libraries;..\..\Libraries\seekfree_peripheral;..\CODE;..\
                    -USER\inc;..\USER\src) DEBUG PRINT(.\Out_File\control.lst) OBJECT(.\Out_File\control.obj) 

stmt  level    source

    1          /* Includes ------------------------------------------------------------------*/
    2          #include "control.h"
    3          #include "math.h"
    4          #include "circle.h"
    5          #include "hinder.h"
    6          #include "ramp.h"
    7          #include "garage.h"
    8          /* Includes ------------------------------------------------------------------*/
    9          
   10          //µç»ú¿ØÖÆÏà¹Ø
   11          void Speed_Control(float left, float right);            //µç»ú±Õ»·¿ØÖÆ
   12          void Speed_diff_control();                                                      //µç»ú±Õ»·+²îËÙ¿ØÖÆ
   13          
   14          void Stop_after(float distance);                                        //ÔËÐÐÖ¸¶¨¾àÀë×Ô¶¯Í£³µ µ¥Î»m
   15          
   16          //Ìõ¼þ¼ì²âÏà¹Ø
   17          void Circle_judge_dir();   //ÓÐ·½Ïò»·µºÅÐ¶Ï
   18          void Out_Track_judge();    //³ö½ç¼ì²â
   19          
   20          /****************************************************
   21           * @name              ¶Â×ª¼ì²â
   22           * @function      block_judge
   23           * @parameter     NULL
   24           * @return                NULL
   25           * @date                  2023/7/27
   26           ***************************************************/
   27          void block_judge(){
   28   1      
   29   1              static int count = 0;
   30   1      
   31   1              if((my_abs(car.motor_left.speed_Current)+my_abs(car.motor_right.speed_Current))/2<50){
   32   2                      count++;
   33   2                      if(count>80){
   34   3                              Force_Stop();
   35   3                      }
   36   2              }
   37   1      }
   38          /****************************************************
   39           * @name              ×ßÒ»¶Î¾àÀëÍ£Ö¹
   40           * @function      Stop_after
   41           * @parameter     NULL
   42           * @return                NULL
   43           * @date                  2023/7/27
   44           ***************************************************/
   45          void Stop_after(float distance)
   46          {
   47   1              if (car.distance > distance * 100)
   48   1              {
   49   2                      Force_Stop();
   50   2                      car.distance = 0;
   51   2              }
   52   1      }
   53          /****************************************************
   54           * @name              Out_Track_judge
   55           * @function      ³ö½ç±£»¤
   56           * @parameter     NULL
   57           * @return                NULL
C251 COMPILER V5.60.0,  control                                                            11/10/23  17:40:20  PAGE 2   

   58           * @date                  2023/7/12
   59           ***************************************************/
   60          void Out_Track_judge()
   61          {
   62   1              static int out_count = 0;
   63   1      
   64   1              if (car.road_type != OUT_GARAGE &&car.road_type != RAMP&& car.road_type != ENTER_GARAGE)
   65   1              {
   66   2                      if (car.adc_parameter.adc_strength <= 10 )
   67   2                      {
   68   3                              out_count++;
   69   3                              if (out_count > 50)
   70   3                              {
   71   4                                      out_count = 0;
   72   4                                      Force_Stop();
   73   4                                      car.road_type = OUT_TRACK;
   74   4                              }
   75   3                      }
   76   2                      else
   77   2                      {
   78   3                              out_count = 0;
   79   3                      }
   80   2              }
   81   1      }
   82          /****************************************************
   83           * @name              Straight_control
   84           * @function      Ö±µÀ×ªÏò¿ØÖÆ
   85           * @parameter     NULL
   86           * @return                NULL
   87           * @date                  2023/7/4
   88           ***************************************************/
   89          void Straight_control()
   90          {
   91   1              static int count_10ms = 0;
   92   1      
   93   1              /***************************ÔªËØ¼ì²â****************************/
   94   1          if(car.distance > 5)
   95   1          {           
   96   2                /*******Í£³µ********/
   97   2      //              if(car.garage.MODE==0)
   98   2              if((car.element.excel[car.element.ELEMENT_NUM]==9)||(car.element.excel[car.element.ELEMENT_NUM]==10))
   99   2              {
  100   3                      if(car.element.excel[car.element.ELEMENT_NUM]==9)//×óÈë¿â
  101   3                      {
  102   4                              car.garage.DIR=LEFT;
  103   4                      }
  104   3                      if(car.element.excel[car.element.ELEMENT_NUM]==10)//ÓÒÈë¿â
  105   3                      {
  106   4                              car.garage.DIR=RIGHT;
  107   4                      }
  108   3                /******ÕýÏòÈë¿â¾àÀë¼ì²â******/
  109   3                      Enter_Garage_Pre();
  110   3                /******ÕýÏòÈë¿â¾àÀë¼ì²â******/
  111   3                      CitTie_judge();
  112   3              }
  113   2      //              else if(car.garage.MODE==1)
  114   2      //              Enter_Garage_Pre();
  115   2           /*******Í£³µ********/
  116   2      
  117   2               /*******Ô²»·********/
  118   2               if((car.element.excel[car.element.ELEMENT_NUM]==2)||(car.element.excel[car.element.ELEMENT_NUM]==3)||(c
             -ar.element.excel[car.element.ELEMENT_NUM]==4)||(car.element.excel[car.element.ELEMENT_NUM]==5)||(car.element.excel[car.e
             -lement.ELEMENT_NUM]==11)||(car.element.excel[car.element.ELEMENT_NUM]==12))
  119   2              {
  120   3                      Circle_judge_dir();
  121   3              } 
C251 COMPILER V5.60.0,  control                                                            11/10/23  17:40:20  PAGE 3   

  122   2               /*******Ô²»·********/
  123   2                      
  124   2               /*******ÆÂµÀ********/
  125   2               if(car.element.excel[car.element.ELEMENT_NUM]==8)
  126   2               {
  127   3                      Ramp_judge();
  128   3               }
  129   2               /*******ÆÂµÀ********/
  130   2      
  131   2               /*******¶Â×ª*********/
  132   2                 block_judge();
  133   2               /*******¶Â×ª*********/
  134   2                       
  135   2               /*******³ö½ç±£»¤******/
  136   2                Out_Track_judge();
  137   2               /*******³ö½ç±£»¤******/
  138   2      /*4320&&(car.distance>4450)*/
  139   2              /*******ÕÏ°­Îï*********/
  140   2              if(((car.element.excel[car.element.ELEMENT_NUM]==6)||(car.element.excel[car.element.ELEMENT_NUM]==7))
  141   2              &&((car.distance-car.circle.out_point)>car.circle_distance)
  142   2              &&((car.distance-car.ramp.in_point)>car.ramp_distance))
  143   2              {
  144   3                      //×ó±ÜÕÏ
  145   3                      if(car.element.excel[car.element.ELEMENT_NUM]==6)
  146   3                      {
  147   4                              car.hinder.dir=LEFT;
  148   4                      }
  149   3                      //ÓÒ±ÜÕÏ
  150   3                      if(car.element.excel[car.element.ELEMENT_NUM]==7)
  151   3                      {
  152   4                              car.hinder.dir=RIGHT;
  153   4                      }
  154   3                      hinder_judge();
  155   3              }
  156   2               /*******ÕÏ°­Îï********/
  157   2      }       
  158   1      
  159   1          Stop_after(car.meter_distance);
  160   1      
  161   1      
  162   1              /***************************ÔªËØ¼ì²â****************************/
  163   1              car.adc_parameter.adc_min[LEFT_H]  = 400;
  164   1              car.adc_parameter.adc_min[MIDDLE]  = 400;
  165   1              car.adc_parameter.adc_min[RIGHT_H] = 400;
  166   1              error_calculate(car.straight.kp,car.straight.kd);
  167   1              /******×ªÏò¿ØÖÆ******/
  168   1              motor_control(car.straight.base_speed-car.steering.duty,car.straight.base_speed+car.steering.duty);
  169   1              //motor_control(car.straight.base_speed,car.straight.base_speed);
  170   1              /******×ªÏò¿ØÖÆ******/
  171   1      }
  172          
  173          /****************************************************
  174           * @name              motor_control
  175           * @function      Ô²»·
  176           * @parameter     left_speed  ×óÂÖËÙ¶È
  177           *                right_speed ÓÒÂÖËÙ¶È
  178           * @return                NULL
  179           * @date                  2023/7/4
  180           ***************************************************/
  181          void motor_control(float left_speed,float right_speed){
  182   1      
  183   1              //¸ø×óÓÒµç»úÆÚÍû×ªËÙ
  184   1              car.motor_left.speed_Expected  = left_speed;
  185   1              car.motor_right.speed_Expected = right_speed;
  186   1      
  187   1              if(car.start_flag){
C251 COMPILER V5.60.0,  control                                                            11/10/23  17:40:20  PAGE 4   

  188   2                      MotorPID_Caculate(&car.motor_left);
  189   2                      MotorPID_Caculate(&car.motor_right);
  190   2              }
  191   1              MotorPWM_Out(car.motor_left.duty, car.motor_right.duty);
  192   1      }
  193          /****************************************************
  194           * @name              error_calculate
  195           * @function      Æ«²î¼ÆËã
  196           * @parameter     error_kp  Ò»´ÎÏîÏµÊý
  197           *                gyro_kp   ÍÓÂÝÒÇÒÖÖÆ
  198           * @return                NULL
  199           * @date                  2023/7/4
  200           ***************************************************/
  201          void error_calculate(float error_kp,float gyro_kp)
  202          {
  203   1      
  204   1              car.steering.linear_error_kp = error_kp;
  205   1              car.steering.gyro_kp         = gyro_kp;
  206   1      
  207   1              get_error_normal(&car.adc_parameter); //¼ÆËãÆ«²î        
  208   1              car.steering.error_now = car.adc_parameter.adc_error ;  
  209   1              //·½Ïò»·¼ÆËã
  210   1              if(car.lose_flag)       //¶ªÏß×´Ì¬
  211   1              {       
  212   2                      if(car.adc_parameter.adc_normalized[LEFT_H]>3&&car.adc_parameter.adc_normalized[RIGHT_H]>3)
  213   2                      {
  214   3                              car.lose_flag = 0;
  215   3                              //BEEP_OFF;
  216   3                      }
  217   2              }
  218   1              else
  219   1              {
  220   2                      if(car.adc_parameter.adc_normalized[LEFT_H]<1&&car.adc_parameter.adc_normalized[RIGHT_H]<1)
  221   2                      {
  222   3                              car.lose_flag = 1;
  223   3                              //BEEP_ON;
  224   3                      }
  225   2                      car.steering.duty = car.steering.linear_error_kp*car.steering.error_now +                              
             -                 //Ò»´ÎÆ«²î   
  226   2                                                                                      car.steering.quadratic_error_kp*car.steering.error_now*abs(car.steering.error_now) +    //¶þ´ÎÆ
             -«²î
  227   2                                                                                      car.steering.error_kd*(car.steering.error_now - car.steering.error_last) -                  //Æ«²î²î·Ö
  228   2                                                                                      car.steering.gyro_kp *icmdata.YawVelocity;                                                                                                                    //ÍÓÂÝÒÇÒÖÖÆ
  229   2                      car.steering.error_last = car.steering.error_now;
  230   2              }
  231   1              //×ªÏòPWMÏÞ·ù
  232   1              if(car.steering.duty>300)      car.steering.duty = 300;
  233   1              else if(car.steering.duty<-300)car.steering.duty =-300;
  234   1      }
  235          /****************************************************
  236           * @name              Normal_Tracing
  237           * @function      Ñ°¼£Ä£Ê½
  238           * @parameter     NULL
  239           * @return                NULL
  240           * @date                  2023/7/4
  241           ***************************************************/
  242          void Normal_Tracing()
  243          {
  244   1      
  245   1              //µç¸ÐÊý¾Ý²É¼¯
  246   1              ADC_Process(&car.adc_parameter);           //¾ùÖµÂË²¨
  247   1              ADC_Normalization(&car.adc_parameter); //¹éÒ»»¯ 0-100
  248   1              //ÍÓÂÝÒÇÊý¾Ý²É¼¯
  249   1              ICM_OneOrderFilter();   
  250   1              //ËÙ¶È²âÁ¿
  251   1              EncoderPulseGet();
C251 COMPILER V5.60.0,  control                                                            11/10/23  17:40:20  PAGE 5   

  252   1              //·çÉÈ
  253   1      
  254   1              //×´Ì¬»ú
  255   1              switch (/*car.road_type*/STRAIGHT)
  256   1              {
  257   2                      //Ö±µÀ
  258   2                      case STRAIGHT:
  259   2                              Straight_control(); //Ö±µÀ·½Ïò¿ØÖÆ
  260   2                              break;
  261   2                      //Èë¿â
  262   2                      case ENTER_GARAGE:
  263   2                              Enter_garage_back(car.garage.DIR); //1 ÓÒ¿â 0 ×ó¿â
  264   2                              break;
  265   2                      //³ö¿â
  266   2                      case OUT_GARAGE:
  267   2                              
  268   2                      /*****³öÈë¿â·½Ïò¸ù¾ÝÔªËØ±íÅÐ¶Ï*******/
  269   2                      if(car.element.excel[car.element.ELEMENT_NUM]==0)
  270   2                      {
  271   3                              car.garage.DIR= 0;   //£¨×ó0ÓÒ1£©
  272   3                      }
  273   2                      if(car.element.excel[car.element.ELEMENT_NUM]==1)
  274   2                      {
  275   3                              car.garage.DIR= 1;   //£¨×ó0ÓÒ1£©
  276   3                      }
  277   2                      /*****³öÈë¿â·½Ïò¸ù¾ÝÔªËØ±íÅÐ¶Ï*******/
  278   2      
  279   2                              Out_garage(car.garage.DIR);
  280   2                              break;
  281   2                      //Ô²»·
  282   2                      case CIRCLE:
  283   2                              Circle_control();
  284   2                              car.road_type_last = CIRCLE;
  285   2                              break;
  286   2                      //ÆÂµÀ
  287   2                      case RAMP:
  288   2                              Ramp_control();
  289   2                              car.road_type_last = RAMP;
  290   2                        break;
  291   2                      //ÕÏ°­
  292   2                      case HINDER:
  293   2                              hinder_control();
  294   2                              break;
  295   2                      //ÕýÏòÈë¿â
  296   2                      case ENTER_GARAGE_forward:
  297   2                              Enter_Garage_control();
  298   2                              break;
  299   2      
  300   2              }
  301   1      }


Module Information          Static   Overlayable
------------------------------------------------
  code size            =       959     ------
  ecode size           =    ------     ------
  data size            =    ------     ------
  idata size           =    ------     ------
  pdata size           =    ------     ------
  xdata size           =    ------     ------
  xdata-const size     =    ------     ------
  edata size           =         6     ------
  bit size             =    ------     ------
  ebit size            =    ------     ------
  bitaddressable size  =    ------     ------
  ebitaddressable size =    ------     ------
  far data size        =    ------     ------
C251 COMPILER V5.60.0,  control                                                            11/10/23  17:40:20  PAGE 6   

  huge data size       =    ------     ------
  const size           =    ------     ------
  hconst size          =        18     ------
End of Module Information.


C251 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
